# Библиотека TF2 и преобразования координат

Каждый робот состоит из множества частей, связанных неподвижно или способных перемещаться друг относительно друга определенным образом. Поэтому, чтобы обеспечить согласованное движение механизма как целого, необходимо научиться анализировать взаимное положение его компонент. 

![Simple scara bot](images/scara_bot.png)

[источник картинки](https://www.machinedesign.com/robotics/what-s-difference-between-industrial-robots)

Зная геометрию и механику робота, мы можем достаточно успешно решать задачи такого типа. И в ROS2 есть хорошие инструменты, существенно упрощающие работу.  Первый из них – библиотека преобразований tf2.

Обсудим, как она работает: 
1. С каждым логически обособленным звеном робота связывается своя система координат (она же репер).
2. Получившиеся реперы упорядочиваются в древовидную структуру.  Где определена одна базовая с.к. (задающая положение робота в окружающем мире), от которой растут дочерние координатные системы. 
3. Дочерняя координатная система связана с родительской с помощью движения (композиции  перемещения и поворота без искажения осей)
4. Циклы в дереве не допускаются (т.е. каждый репер за исключением базового имеет единственного родителя, у базового репера родителей нет).

На рис. выше представлен набор реперов, описывающий связь всех звеньев робота.Такая структура позволяет быстро пересчитывать координаты объектов между координатными системами, определенными в дереве.

Т.о. библиотека tf2 помогает
1. решать задачи прямой и обратной кинематики для роботов со множеством сочленений
2. приводить данные сенсоров, расположенных в различных местах робота к единой системе координат
3. локализовывать робота и определять геометрию окружающего пространства 


## Практика

### rqt + tf_tree

В качестве примера работы с библиотекой рассмотрим черепашку-преследователя из документации ROS2. Установим необходимые пакеты

```bash
sudo apt-get install ros-humble-turtle-tf2-py ros-humble-tf2-tools ros-humble-tf-transformations ros-humble-rqt-tf-tree
```

Далее в двух различных терминалах запускаем сперва настраиваем базовые оверлеи ROS2, а потом  черепашку с преследованием и консоль управления.

Терминал №1
```bash
source /opt/ros/humble/setup.bash
ros2 launch turtle_tf2_py turtle_tf2_demo.launch.py
```

Терминал №2
```bash
source /opt/ros/humble/setup.bash
ros2 run turtlesim turtle_teleop_key
```

В терминале с консолью управления можно порулить черепашкой и посмотреть на результат. Мы же обратим внимание на дерево, созданное библиотекой tf2
rqt с плагинами (node, tf_tree). В новом терминале запустим инструмент rqt
```bash
rqt
```
Сейчас он отображает вычислительный граф черепашки, чтобы увидеть дерево преобразований, подключим плагин tf tree. 

### rviz2

С каждой черепашкой связана своя система координат. Но обе они являются дочерними по отношению к мировым координатам. Координатные системы можно визуализировать в динамике с помощью инструмента rviz. 

```bash
rviz2
```
Подключаем плагин tf2. Теперь, перемещая черепашек, мы видим, как изменяются связанные с ними координатные реперы.


### Операции с координатными реперами

Последний инструмент на сегодня. Добавим собственный репер, статический связанный с одной из черепашек (можно представить себе в виде координат камеры, летающей вслед за ней). Он будет публиковать информацию о своём положении в топик /tf_static

```bash
ros2 run tf2_ros static_transform_publisher --x x --y y --z z --yaw yaw --pitch pitch --roll roll --frame-id frame_id --child-frame-id child_frame_id
```

Чтобы добавить такой репер, необходимо указать его координаты и ориентацию относительно родительского репера (черепашки), название родительского репера, а также собственное название новых координат

```bash
ros2 run tf2_ros static_transform_publisher 0 0 1 0 0 0 turtle1 camera
```

Появился новый координатный репер. Мы задали его так, что он будет менять своего положения относительно черепашки turtle1. Поэтому при движении, он всегда будет находится строго над ней. Cтатические преобразования публикуются в /tf_static динамические в /tf. 



## Дополнительные материалы

[Официальная документация ROS2 Humble](https://docs.ros.org/en/humble/Tutorials/Intermediate/Tf2/Introduction-To-Tf2.html)

[Getting Ready for ROS Part 6: The Transform System (TF)](https://articulatedrobotics.xyz/ready-for-ros-6-tf/)

